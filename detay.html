<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kovan Detayı - Kovan Takip</title>

    <style>
        /* --- TEMEL STİLLER --- */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        h1 { color: #333; margin-right: auto; font-size: 1.5em; }
        .user-info { display: flex; align-items: center; gap: 10px; margin-left: auto; /* Sağa yaslamak için */ }
        .user-email { font-weight: bold; color: #555; font-size: 0.9em; }

        /* --- BUTON STİLLERİ --- */
        .ana-buton-grup { display: flex; gap: 8px; flex-wrap: wrap; width: 100%; margin-top: 10px; justify-content: flex-end; }
        .buton { color: white; padding: 8px 12px; text-decoration: none; border-radius: 5px; font-weight: bold; border: none; cursor: pointer; font-size: 0.85em; white-space: nowrap; }
        .geri-btn { background-color: #6c757d; } .geri-btn:hover { background-color: #5a6268; }
        /* Ana Sil Butonu */
        .sil-btn { background-color: #dc3545; } .sil-btn:hover { background-color: #c82333; } .sil-btn:disabled { background-color: #aaa; cursor: not-allowed; }
        .duzenle-btn { background-color: #007bff; } .duzenle-btn:hover { background-color: #0056b3; } .duzenle-btn:disabled { background-color: #aaa; cursor: not-allowed; }
        .kaydet-btn { background-color: #28a745; } .kaydet-btn:hover { background-color: #218838; } .kaydet-btn:disabled { background-color: #aaa; cursor: not-allowed; }
        .logout-btn { background-color: #ffc107; color: #333; } .logout-btn:hover { background-color: #e0a800; }

        /* --- DETAY ve DÜZENLEME KARTLARI --- */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .info-card, .edit-form-container { background-color: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 20px; grid-column: span 1; }
        .edit-form-container { grid-column: span 2; }
        .info-card h2, .edit-form-container h2 { margin-top: 0; color: #007bff; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 1.2em; }
        .info-card p { font-size: 1em; line-height: 1.5; margin: 8px 0; }
        .info-card strong { color: #333; min-width: 130px; display: inline-block; }

        /* --- FORM STİLLERİ --- */
        .form-grup { margin-bottom: 12px; }
        .form-grup label { display: block; margin-bottom: 4px; font-weight: bold; font-size: 0.9em; color: #555;}
        .form-grup input, .form-grup select, .form-grup textarea { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 0.95em; }
        .checkbox-grup { display: flex; align-items: center; } .checkbox-grup input { width: auto; margin-right: 8px; }

        /* --- KAYIT BÖLÜMLERİ --- */
        .kayitlar-bolumu { grid-column: span 2; margin-top: 20px; background-color: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 20px; }
        .kayitlar-bolumu h2 { margin-top: 0; color: #17a2b8; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 1.2em; }
        .kayit-ekleme-formu { background-color: #fdfdfd; border: 1px dashed #ccc; border-radius: 5px; padding: 15px; margin-top: 15px; margin-bottom: 20px; }
        .kayit-ekleme-formu h3 { margin-top: 0; color: #333; font-size: 1.1em; }
        .kayit-ekleme-formu button { background-color: #28a745; color: white; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.9em; }
        .kayit-ekleme-formu button:hover { background-color: #218838; } .kayit-ekleme-formu button:disabled { background-color: #aaa; }

        /* Kayıt Listesi Stilleri */
        .kayit-listesi-item { position: relative; border: 1px solid #eee; background: #fafafa; padding: 12px 15px; margin-top: 10px; border-radius: 4px; padding-right: 125px; /* Butonlara yer aç */ }
        .kayit-listesi-item p { margin: 4px 0; font-size: 0.95em; line-height: 1.4; }
        .kayit-listesi-item strong { font-weight: bold; }
        .kayit-listesi-item span { font-size: 0.85em; color: #666; display: block; margin-bottom: 5px; }
        .kayit-listesi-item .buton-alan { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
        /* Kayıt butonları */
        .kayit-duzenle-btn, .kayit-sil-btn, .kayit-kaydet-btn, .kayit-iptal-btn { padding: 3px 8px; font-size: 0.8em; }
        .kayit-duzenle-btn { background-color: #ffc107; color: #333; } .kayit-duzenle-btn:hover { background-color: #e0a800; }
        .kayit-kaydet-btn { background-color: #28a745; } .kayit-kaydet-btn:disabled { background-color: #aaa; }
        .kayit-iptal-btn { background-color: #6c757d; }
        /* Kayıt Sil Butonu (KIRMIZI) */
        .kayit-sil-btn { background-color: #dc3545 !important; color: white !important; }
        .kayit-sil-btn:hover { background-color: #c82333 !important; }
        .kayit-sil-btn:disabled { background-color: #aaa !important; cursor: not-allowed; }

        /* Kayıt Düzenleme Formu Görünürlüğü */
        .kayit-duzenleme-formu { display: none; margin-top: 5px; }
        .kayit-duzenleme-formu .form-grup { margin-bottom: 8px; }
        .kayit-listesi-item.duzenleniyor .kayit-icerik { display: none; }
        .kayit-listesi-item.duzenleniyor .kayit-duzenleme-formu { display: block; }
        .kayit-listesi-item.duzenleniyor .kayit-duzenle-btn { display: none; }
        .kayit-listesi-item .kayit-kaydet-btn, .kayit-listesi-item .kayit-iptal-btn { display: none; }
        .kayit-listesi-item.duzenleniyor .kayit-kaydet-btn, .kayit-listesi-item.duzenleniyor .kayit-iptal-btn { display: inline-block; }
        .kayit-listesi-item.duzenleniyor .kayit-sil-btn { display: none; } /* Düzenlemede sil gizlensin */

        .bakim-listesi-item { border-left: 5px solid #007bff; } .bakim-listesi-item strong { color: #007bff; }
        .hastalik-listesi-item { border-left: 5px solid #dc3545; } .hastalik-listesi-item strong { color: #dc3545; }
        .hasat-listesi-item { border-left: 5px solid #28a745; } .hasat-listesi-item strong { color: #28a745; }

        /* Mobil Uyum */
        @media (max-width: 768px) {
            .grid-container { grid-template-columns: 1fr; }
            .info-card, .edit-form-container, .kayitlar-bolumu { grid-column: span 1; }
            .header { flex-direction: column; align-items: stretch; }
            .user-info { justify-content: space-between; margin-top: 10px; width: 100%; margin-left: 0; }
            .ana-buton-grup { width: 100%; margin-top: 10px; justify-content: space-between; }
            .buton { flex-grow: 1; text-align: center; }
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

    <div class="header">
        <h1 id="kovan-baslik">Kovan Detayı Yükleniyor...</h1>
        <div class="user-info">
             <span id="userEmail" class="user-email"></span>
             <button id="logoutBtn" class="buton logout-btn">Çıkış</button>
        </div>
        <div class="ana-buton-grup">
            <a href="kovanlarim.html" class="buton geri-btn">❮ Kovan Listesi</a>
            <button id="duzenleBtn" class="buton duzenle-btn" disabled>✎ Düzenle</button>
            <button id="kaydetBtn" class="buton kaydet-btn" style="display:none;" disabled>✔ Kaydet</button>
            <button id="iptalBtn" class="buton geri-btn" style="display:none;" disabled>İptal</button>
            <button id="silKovanBtn" class="buton sil-btn" disabled>✖ Kovanı Sil</button>
        </div>
    </div>

    <div id="kovan-detay-container" class="grid-container"> <p>Yükleniyor...</p> </div>
    <div id="kovan-kayitlar-container"> <p>Yükleniyor...</p> </div>

    <datalist id="hastalik-listesi-datalist"> <option value="Varroa"></option> <option value="Nosema"></option> <option value="Amerikan Yavru Çürüklüğü"></option> <option value="Avrupa Yavru Çürüklüğü"></option> <option value="Kireç Hastalığı"></option> <option value="Petek Güvesi"></option> <option value="Stres / Açlık"></option> <option value="Diğer"></option> </datalist>
    <datalist id="ilac-yontem-listesi-datalist"> <option value="Formik Asit - Damlatma"></option> <option value="Formik Asit - Ped"></option> <option value="Oksalik Asit - Damlatma"></option> <option value="Oksalik Asit - Buharlaştırma"></option> <option value="Amitraz Şerit (Varroset vb.)"></option> <option value="Timol Jel/Ped (Apiguard vb.)"></option> <option value="Organik Asit Kombinasyonu"></option> <option value="Erkek Arı Gözü Kesimi"></option> <option value="Pudra Şekeri"></option> <option value="Antibiyotik (Veteriner Tavsiyesiyle)"></option> <option value="B401 (Petek Güvesi İçin)"></option> <option value="Çerçeve Değişimi"></option> <option value="Besleme (Şurup/Kek)"></option> <option value="Diğer"></option> </datalist>

    <script>
        // --- Firebase Config ve Başlatma ---
        const firebaseConfig = {
          apiKey: "AIzaSyAO7203PN7V8IBxYe0B13iRy0Ahwzm5sXY", // KENDİ BİLGİLERİNİZLE DEĞİŞTİRİN
          authDomain: "kovan-takip-4c054.firebaseapp.com",
          projectId: "kovan-takip-4c054",
          storageBucket: "kovan-takip-4c054.appspot.com",
          messagingSenderId: "783431210365",
          appId: "1:783431210365:web:5810ec74c9ff3ba8d4a814"
        };
        try { firebase.initializeApp(firebaseConfig); console.log("Firebase başlatıldı."); }
        catch (e) { console.error("Firebase başlatılamadı:", e); document.body.innerHTML = '<h1>HATA</h1>'; throw e; }
        const db = firebase.firestore(); const auth = firebase.auth();

        // --- HTML Element Referansları ---
        const kovanBaslik = document.getElementById('kovan-baslik');
        const detayContainer = document.getElementById('kovan-detay-container');
        const kayitlarContainer = document.getElementById('kovan-kayitlar-container');
        const logoutBtn = document.getElementById('logoutBtn');
        const userEmailElement = document.getElementById('userEmail');

        // --- Global Değişkenler ---
        const urlParams = new URLSearchParams(window.location.search);
        let kovanId = null; try { kovanId = decodeURIComponent(urlParams.get('id')); } catch (e) { console.error("ID alınamadı:", e); }
        let mevcutKovanVerisi = null;
        let mevcutKullanici = null; // DOĞRU YAZIM
        let anaDuzenlemeModu = false;

        // --- Auth Durumu Dinleyicisi ---
        auth.onAuthStateChanged((user) => {
          if (user) {
            mevcutKullanici = user; // DOĞRU YAZIM
            userEmailElement.textContent = `(${mevcutKullanici.email})`; // DOĞRU YAZIM
            yukleKovanDetayi();
          } else { window.location.href = 'login.html'; }
        });

        // --- Çıkış Butonu ---
        logoutBtn.addEventListener('click', () => { auth.signOut().catch(e => console.error(e)); });

        // --- Ana Fonksiyon: Kovan Detayını Yükle ---
        async function yukleKovanDetayi() {
            console.log("yukleKovanDetayi başladı.");
            ['duzenleBtn', 'kaydetBtn', 'iptalBtn', 'silKovanBtn'].forEach(id => { const btn = document.getElementById(id); if (btn) btn.disabled = true; });
            if (!mevcutKullanici || !kovanId) { console.warn("Kullanıcı/ID eksik."); return; }
            try {
                const docRef = db.collection("kovanlar").doc(kovanId);
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    const kovanData = docSnap.data();
                    if (!kovanData.userId || kovanData.userId !== mevcutKullanici.uid) { console.error("Yetki Hatası"); kovanBaslik.innerText = "Erişim Reddedildi"; detayContainer.innerHTML = "<p>Erişim izniniz yok.</p>"; kayitlarContainer.innerHTML=''; return; }
                    mevcutKovanVerisi = kovanData;
                    kovanBaslik.innerText = `Kovan No: ${mevcutKovanVerisi.kovanNo}`;
                    renderViewMode(); // Tüm görünümü çiz
                    kurAnaButonListenerlari();
                    const duzenleBtn = document.getElementById('duzenleBtn'); const silBtn = document.getElementById('silKovanBtn');
                    if(duzenleBtn) duzenleBtn.disabled = false; if(silBtn) silBtn.disabled = false;
                    console.log("yukleKovanDetayi tamamlandı.");
                } else { console.error("Kovan bulunamadı"); kovanBaslik.innerText="Hata"; detayContainer.innerHTML=`<p>Kovan bulunamadı.</p>`; }
            } catch (error) { console.error("Yükleme Hatası:", error); kovanBaslik.innerText="Hata"; detayContainer.innerHTML = "<p>Veri yüklenirken hata.</p>"; }
        }

        // --- Ana Buton Listener'larını Kur ---
        function kurAnaButonListenerlari() {
            const setupListener = (buttonId, event, handler) => { const button = document.getElementById(buttonId); if (button) { const newButton = button.cloneNode(true); button.parentNode.replaceChild(newButton, button); newButton.addEventListener(event, handler); console.log(`Listener kuruldu: ${buttonId}`); } else { console.error(`Buton bulunamadı: ${buttonId}`); } };
            setupListener('duzenleBtn', 'click', () => toggleAnaEditMode(true));
            setupListener('iptalBtn', 'click', () => toggleAnaEditMode(false));
            setupListener('kaydetBtn', 'click', handleUpdateSubmit);
            setupListener('silKovanBtn', 'click', kovayiSil);
        }

        // --- ANA Kovan Bilgileri İçin Görünüm/Düzenleme Geçişi ---
        function toggleAnaEditMode(isEditing) {
            console.log(`toggleAnaEditMode: ${isEditing}`);
            if (!mevcutKullanici || !mevcutKovanVerisi) return; // DOĞRU YAZIM
            anaDuzenlemeModu = isEditing;
            renderViewMode(); // Sayfayı yeniden çiz
            const duzenleBtn=document.getElementById('duzenleBtn'); const silBtn=document.getElementById('silKovanBtn'); const kaydetBtn=document.getElementById('kaydetBtn'); const iptalBtn=document.getElementById('iptalBtn');
            if(duzenleBtn) duzenleBtn.style.display = isEditing ? 'none' : 'inline-block'; if(silBtn) silBtn.style.display = isEditing ? 'none' : 'inline-block';
            if(kaydetBtn) kaydetBtn.style.display = isEditing ? 'inline-block' : 'none'; if(iptalBtn) iptalBtn.style.display = isEditing ? 'inline-block' : 'none';
            if(duzenleBtn) duzenleBtn.disabled = isEditing; if(silBtn) silBtn.disabled = isEditing;
            if(kaydetBtn) kaydetBtn.disabled = !isEditing; if(iptalBtn) iptalBtn.disabled = !isEditing;
        }

        // --- TÜM SAYFAYI YENİDEN OLUŞTURAN ANA FONKSİYON ---
        function renderViewMode() {
            if (!mevcutKovanVerisi) { console.warn("renderViewMode: mevcutKovanVerisi yok."); return; }
            console.log("renderViewMode çağrıldı. Ana Düzenleme Modu:", anaDuzenlemeModu);
            detayContainer.innerHTML = ''; kayitlarContainer.innerHTML = '';
            if (anaDuzenlemeModu) { renderAnaEditMode(mevcutKovanVerisi); } else { renderAnaViewMode(mevcutKovanVerisi); }
            renderKayitBolumu('bakim', 'Dönemsel Bakım Notları', 'bakimKayitlari', 'bakimTarihi', handleBakimSubmit, bakimKayitlariniListele);
            renderKayitBolumu('hastalik', 'Hastalık Mücadele Kayıtları', 'hastalikKayitlari', 'tedaviTarihi', handleHastalikSubmit, hastalikKayitlariniListele);
            renderKayitBolumu('hasat', 'Bal Hasat Kayıtları', 'hasatKayitlari', 'hasatTarihi', handleHasatSubmit, hasatKayitlariniListele);
            console.log("renderViewMode tamamlandı.");
        }

        // --- Ana Kovan Bilgilerini Görüntüleme Kartları ---
        function renderAnaViewMode(kovan) {
            console.log("renderAnaViewMode");
            const temelBilgilerCard = document.createElement('div'); temelBilgilerCard.className = 'info-card';
            temelBilgilerCard.innerHTML = `<h2>Kovan Bilgileri</h2> <p><strong>B. Barkod:</strong> ${kovan.barkodNo || 'N/A'}</p> <p><strong>Arı Irkı:</strong> ${kovan.ariIrki || 'N/A'}</p> <p><strong>Kovan Tipi:</strong> ${kovan.kovanTipi || 'N/A'}</p> <p><strong>Çerçeve S.:</strong> ${kovan.cerceveSayisi || 'N/A'}</p> <p><strong>Kökeni:</strong> ${kovan.kovanKokeni || 'N/A'}</p> <p><strong>Hırçınlık:</strong> ${kovan.hircinlik || 'N/A'}</p> <p><strong>Polen T.:</strong> ${kovan.polenTuzagi ? 'Var' : 'Yok'}</p> <p><strong>Delikli T.:</strong> ${kovan.tabanDelikliMi ? 'Var' : 'Yok'}</p>`;
            detayContainer.appendChild(temelBilgilerCard);
            const anaAriCard = document.createElement('div'); anaAriCard.className = 'info-card';
            anaAriCard.innerHTML = `<h2>Ana Arı</h2> <p><strong>Irkı:</strong> ${kovan.anaAri.anaIrki || 'N/A'}</p> <p><strong>Rengi:</strong> ${kovan.anaAri.anaRengi || 'N/A'}</p> <p><strong>Türü:</strong> ${kovan.anaAri.anaTuru || 'N/A'}</p> <p><strong>Doğum T.:</strong> ${kovan.anaAri.dogumTarihi || 'N/A'}</p> <p><strong>Değişim T.:</strong> ${kovan.anaAri.degisimTarihi || 'N/A'}</p> <p><strong>Performans:</strong> ${kovan.anaAri.performans || 'N/A'}</p>`;
            detayContainer.appendChild(anaAriCard);
        }

        // --- Ana Kovan Bilgileri Düzenleme Formu ---
        function renderAnaEditMode(kovan) {
            console.log("renderAnaEditMode");
            const setSelected=(v1,v2)=>v1===v2?'selected':''; const setChecked=(v)=>v?'checked':'';
            const editFormContainer = document.createElement('div'); editFormContainer.className = 'edit-form-container';
            editFormContainer.innerHTML = `<h2>Kovan Bilgilerini Düzenle</h2> <form id="kovanDuzenleFormu"><div class="grid-container"><div> <div class="form-grup"><label>Kovan No</label><input type="text" value="${kovan.kovanNo}" disabled></div> <div class="form-grup"><label>Barkod</label><input type="text" id="editBarkodNo" value="${kovan.barkodNo||''}"></div> <div class="form-grup"><label>Tip</label><select id="editKovanTipi"><option value="Langstroth" ${setSelected(kovan.kovanTipi,'Langstroth')}>L</option><option value="Dadant" ${setSelected(kovan.kovanTipi,'Dadant')}>D</option><option value="Karakovan" ${setSelected(kovan.kovanTipi,'Karakovan')}>K</option><option value="Diğer" ${setSelected(kovan.kovanTipi,'Diğer')}>Diğer</option></select></div> <div class="form-grup"><label>Irk</label><select id="editAriIrki"><option value="Kafkas" ${setSelected(kovan.ariIrki,'Kafkas')}>Kafkas</option><option value="Anadolu" ${setSelected(kovan.ariIrki,'Anadolu')}>Anadolu</option><option value="Karniyol" ${setSelected(kovan.ariIrki,'Karniyol')}>Karniyol</option><option value="İtalyan" ${setSelected(kovan.ariIrki,'İtalyan')}>İtalyan</option><option value="Belfast" ${setSelected(kovan.ariIrki,'Belfast')}>Belfast</option><option value="Melez" ${setSelected(kovan.ariIrki,'Melez')}>Melez</option></select></div> <div class="form-grup"><label>Çer. Sayısı</label><input type="number" id="editCerceveSayisi" value="${kovan.cerceveSayisi||0}" min="1"></div> <div class="form-grup"><label>Köken</label><select id="editKovanKokeni"><option value="Kendi Üretimim" ${setSelected(kovan.kovanKokeni,'Kendi Üretimim')}>Kendi</option><option value="Satın Alma" ${setSelected(kovan.kovanKokeni,'Satın Alma')}>Satın</option><option value="Oğul" ${setSelected(kovan.kovanKokeni,'Oğul')}>Oğul</option></select></div> <div class="form-grup"><label>Hırçınlık</label><select id="editHircinlik"><option value="1 - Çok Sakin" ${setSelected(kovan.hircinlik,'1 - Çok Sakin')}>1</option><option value="2 - Sakin" ${setSelected(kovan.hircinlik,'2 - Sakin')}>2</option><option value="3 - Normal" ${setSelected(kovan.hircinlik,'3 - Normal')}>3</option><option value="4 - Hırçın" ${setSelected(kovan.hircinlik,'4 - Hırçın')}>4</option><option value="5 - Çok Hırçın" ${setSelected(kovan.hircinlik,'5 - Çok Hırçın')}>5</option></select></div> <div class="checkbox-grup"><input type="checkbox" id="editTabanDelikliMi" ${setChecked(kovan.tabanDelikliMi)}><label>Delikli T.</label></div> <div class="checkbox-grup"><input type="checkbox" id="editPolenTuzagi" ${setChecked(kovan.polenTuzagi)}><label>Polen T.</label></div> </div> <div> <h3>Ana Arı</h3><div class="form-grup"><label>Doğum T.</label><input type="date" id="editAnaDogumTarihi" value="${kovan.anaAri.dogumTarihi||''}"></div><div class="form-grup"><label>Ana Irkı</label><select id="editAnaIrki"><option value="Kafkas" ${setSelected(kovan.anaAri.anaIrki,'Kafkas')}>Kafkas</option><option value="Anadolu" ${setSelected(kovan.anaAri.anaIrki,'Anadolu')}>Anadolu</option><option value="Karniyol" ${setSelected(kovan.anaAri.anaIrki,'Karniyol')}>Karniyol</option><option value="İtalyan" ${setSelected(kovan.anaAri.anaIrki,'İtalyan')}>İtalyan</option><option value="Belfast" ${setSelected(kovan.anaAri.anaIrki,'Belfast')}>Belfast</option><option value="Melez" ${setSelected(kovan.anaAri.anaIrki,'Melez')}>Melez</option></select></div><div class="form-grup"><label>Ana Türü</label><select id="editAnaTuru"><option value="Damızlık (F0)" ${setSelected(kovan.anaAri.anaTuru,'Damızlık (F0)')}>F0</option><option value="Çiftleşmiş (F1)" ${setSelected(kovan.anaAri.anaTuru,'Çiftleşmiş (F1)')}>F1</option><option value="Çiftleşmemiş" ${setSelected(kovan.anaAri.anaTuru,'Çiftleşmemiş')}>Çiftleşmemiş</option><option value="Kendi Ürettiğim" ${setSelected(kovan.anaAri.anaTuru,'Kendi Ürettiğim')}>Kendi</option></select></div><div class="form-grup"><label>Ana Rengi</label><select id="editAnaRengi"><option value="Boyasız" ${setSelected(kovan.anaAri.anaRengi,'Boyasız')}>Boyasız</option><option value="Beyaz" ${setSelected(kovan.anaAri.anaRengi,'Beyaz')}>Beyaz</option><option value="Sarı" ${setSelected(kovan.anaAri.anaRengi,'Sarı')}>Sarı</option><option value="Kırmızı" ${setSelected(kovan.anaAri.anaRengi,'Kırmızı')}>Kırmızı</option><option value="Yeşil" ${setSelected(kovan.anaAri.anaRengi,'Yeşil')}>Yeşil</option><option value="Mavi" ${setSelected(kovan.anaAri.anaRengi,'Mavi')}>Mavi</option></select></div><div class="form-grup"><label>Performansı</label><select id="editAnaPerformans"><option value="Çok İyi" ${setSelected(kovan.anaAri.performans,'Çok İyi')}>Çok İyi</option><option value="İyi" ${setSelected(kovan.anaAri.performans,'İyi')}>İyi</option><option value="Orta" ${setSelected(kovan.anaAri.performans,'Orta')}>Orta</option><option value="Zayıf" ${setSelected(kovan.anaAri.performans,'Zayıf')}>Zayıf</option></select></div><div class="form-grup"><label>Plan. Değ. T.</label><input type="date" id="editAnaDegisimTarihi" value="${kovan.anaAri.degisimTarihi||''}"></div></div></div></form>`;
        detayContainer.appendChild(editFormContainer);
    }

    // --- Ana Kovan Bilgilerini Kaydet ---
    async function handleUpdateSubmit(event) {
        event.preventDefault(); if (!mevcutKullanici || !mevcutKovanVerisi) return; // DOĞRU YAZIM
        console.log("[DEBUG] Ana kovan bilgileri kaydediliyor...");
        const guncelVeri = {
            barkodNo: gf('editBarkodNo') || null, kovanTipi: gf('editKovanTipi') || null, ariIrki: gf('editAriIrki') || null,
            cerceveSayisi: gf('editCerceveSayisi', 'number') || 0, kovanKokeni: gf('editKovanKokeni') || null, hircinlik: gf('editHircinlik') || null,
            tabanDelikliMi: gf('editTabanDelikliMi', 'checked') ?? false, polenTuzagi: gf('editPolenTuzagi', 'checked') ?? false,
            anaAri: {
                dogumTarihi: gf('editAnaDogumTarihi') || null, anaIrki: gf('editAnaIrki') || null, anaTuru: gf('editAnaTuru') || null,
                anaRengi: gf('editAnaRengi') || null, performans: gf('editAnaPerformans') || null, degisimTarihi: gf('editAnaDegisimTarihi') || null
            }, sonGuncelleme: new Date()
        };
        const kaydetButonu = document.getElementById('kaydetBtn'); if(kaydetButonu) kaydetButonu.disabled = true;
        try {
            await db.collection("kovanlar").doc(kovanId).update(guncelVeri);
            alert("Kovan bilgileri güncellendi!");
            mevcutKovanVerisi = { ...mevcutKovanVerisi, ...guncelVeri };
            toggleAnaEditMode(false);
        } catch (error) { console.error("Güncelleme hatası: ", error); alert("Hata: " + error.message); }
        finally { if(kaydetButonu) kaydetButonu.disabled = false; }
    }

    // --- GÜVENLİ KOVAN SİLME ---
     async function deleteSubCollection(dbRef, parentDocRef, collName){ const collRef = parentDocRef.collection(collName); const snap = await collRef.get(); if (snap.empty) return; const batch = dbRef.batch(); snap.forEach(doc => batch.delete(doc.ref)); await batch.commit(); console.log(`${collName} silindi.`); }
     async function kovayiSil() {
         if (!mevcutKullanici || !kovanId || !mevcutKovanVerisi) return; // DOĞRU YAZIM
         if (confirm(`'${kovanId}' kovanını ve TÜM kayıtlarını silmek istediğinizden emin misiniz?`)) {
             const silBtn = document.getElementById('silKovanBtn'); const duzBtn = document.getElementById('duzenleBtn');
             try {
                 if(silBtn) silBtn.disabled = true; if(duzBtn) duzBtn.disabled = true; if(silBtn) silBtn.innerText = "Siliniyor...";
                 const docRef = db.collection("kovanlar").doc(kovanId);
                 await deleteSubCollection(db, docRef, "bakimKayitlari");
                 await deleteSubCollection(db, docRef, "hastalikKayitlari");
                 await deleteSubCollection(db, docRef, "hasatKayitlari");
                 await docRef.delete();
                 alert("Kovan başarıyla silindi."); window.location.href = "kovanlarim.html";
             } catch (error) { console.error("Silme hatası:", error); alert("Hata: " + error.message); if(silBtn) silBtn.disabled = false; if(duzBtn) duzBtn.disabled = false; if(silBtn) silBtn.innerText = "✖ Kovanı Sil"; }
         }
     }

    // ======================================================
    // --- GENEL KAYIT BÖLÜMÜ OLUŞTURMA ---
    // ======================================================
    function renderKayitBolumu(tip, baslik, collName, tarihAdi, submitFn, listeleFn) {
        console.log(`renderKayitBolumu: ${tip}`);
        const kayitAlani = document.createElement('div'); kayitAlani.className = 'kayitlar-bolumu'; kayitAlani.id = `bolum-${tip}`;
        let formHtml = '';
        if (tip === 'bakim') { formHtml = `<h3>Yeni Bakım Kaydı</h3> <div class="form-grup"><label for="bakimTarihi">Tarih</label><input type="date" id="bakimTarihi" required></div> <div class="form-grup"><label for="yapilanIslem">Yapılan İşlem</label><input type="text" id="yapilanIslem" required></div> <div class="form-grup"><label for="bakimNotlari">Notlar</label><textarea id="bakimNotlari" rows="2"></textarea></div> <button type="submit">Ekle</button>`; }
        else if (tip === 'hastalik') { formHtml = `<h3>Yeni Hastalık Kaydı</h3> <div class="form-grup"><label for="hastalikAdi">Hastalık/Zararlı</label><input type="text" id="hastalikAdi" list="hastalik-listesi-datalist" required></div> <div class="form-grup"><label for="tedaviTarihi">Tarih</label><input type="date" id="tedaviTarihi" required></div> <div class="form-grup"><label for="kullanilanIlac">İlaç/Yöntem</label><input type="text" id="kullanilanIlac" list="ilac-yontem-listesi-datalist" required></div> <div class="form-grup"><label for="hastalikNotlari">Notlar</label><textarea id="hastalikNotlari" rows="2"></textarea></div> <button type="submit">Ekle</button>`; }
        else if (tip === 'hasat') { formHtml = `<h3>Yeni Hasat Kaydı</h3> <div class="form-grup"><label for="hasatTarihi">Tarih</label><input type="date" id="hasatTarihi" required></div> <div class="form-grup"><label for="hasatMiktari">Miktar (kg)</label><input type="number" id="hasatMiktari" min="0" step="0.1" required></div> <div class="form-grup"><label for="hasatNotlari">Notlar</label><textarea id="hasatNotlari" rows="2"></textarea></div> <button type="submit">Ekle</button>`; }
        else { return; }
        kayitAlani.innerHTML = `<h2>${baslik}</h2> <div id="${tip}-listesi"><p>Yükleniyor...</p></div> <form id="form${tip.charAt(0).toUpperCase() + tip.slice(1)}Ekle" class="kayit-ekleme-formu"> ${formHtml} </form>`;
        kayitlarContainer.appendChild(kayitAlani);
        const formEl = document.getElementById(`form${tip.charAt(0).toUpperCase() + tip.slice(1)}Ekle`);
        if (formEl) { formEl.replaceWith(formEl.cloneNode(true)); document.getElementById(`form${tip.charAt(0).toUpperCase() + tip.slice(1)}Ekle`).addEventListener('submit', submitFn); }
        else { console.error(`Form bulunamadı: ${tip}`); }
        if (typeof listeleFn === 'function') { listeleFn(kovanId); } else { console.error(`Listeleme fonksiyonu yok: ${tip}`); }
        console.log(`renderKayitBolumu TAMAMLANDI: ${tip}`);
    }

    // ======================================================
    // --- KAYIT EKLEME FONKSİYONLARI ---
    // ======================================================
    function gf(id, type = 'value') { const el=document.getElementById(id); if(!el) return null; return type==='number'?Number(el.value):(type==='checked'?el.checked:el.value); }
    async function handleBakimSubmit(e) { e.preventDefault(); if(!mevcutKullanici) return; const data={bakimTarihi:gf('bakimTarihi'), yapilanIslem:gf('yapilanIslem'), notlar:gf('bakimNotlari')}; await addKayit('bakimKayitlari', data, 'formBakimEkle', bakimKayitlariniListele); }
    async function handleHastalikSubmit(e) { e.preventDefault(); if(!mevcutKullanici) return; const data={hastalikAdi:gf('hastalikAdi'), tedaviTarihi:gf('tedaviTarihi'), kullanilanIlac:gf('kullanilanIlac'), notlar:gf('hastalikNotlari')}; await addKayit('hastalikKayitlari', data, 'formHastalikEkle', hastalikKayitlariniListele); }
    async function handleHasatSubmit(e) { e.preventDefault(); if(!mevcutKullanici) return; const data={hasatTarihi:gf('hasatTarihi'), hasatMiktari:gf('hasatMiktari', 'number'), notlar:gf('hasatNotlari')}; if(isNaN(data.hasatMiktari)||data.hasatMiktari<=0){ alert("Miktar > 0"); return; } await addKayit('hasatKayitlari', data, 'formHasatEkle', hasatKayitlariniListele); }
    async function addKayit(collName, data, formId, listeleFn) {
         console.log(`addKayit: ${collName}`, data); data.eklenmeTarihi = new Date();
         const form = document.getElementById(formId); const btn = form ? form.querySelector('button[type="submit"]') : null;
         if(btn) btn.disabled = true;
         try {
             const docRef = await db.collection("kovanlar").doc(kovanId).collection(collName).add(data);
             console.log(`Kayıt eklendi (${collName}), ID: ${docRef.id}`); alert("Eklendi!"); if(form) form.reset(); listeleFn(kovanId);
         } catch (error) { console.error(`Ekleme hatası (${collName}):`, error); alert(`Hata: ${error.message}`); }
         finally { if(btn) btn.disabled = false; }
     }

    // ======================================================
    // --- KAYIT LİSTELEME FONKSİYONLARI ---
    // ======================================================
    async function bakimKayitlariniListele(kId) { await listeleKayitlar(kId, 'bakim', 'bakimKayitlari', 'bakimTarihi', renderBakimKaydi); }
    async function hastalikKayitlariniListele(kId) { await listeleKayitlar(kId, 'hastalik', 'hastalikKayitlari', 'tedaviTarihi', renderHastalikKaydi); }
    async function hasatKayitlariniListele(kId) { await listeleKayitlar(kId, 'hasat', 'hasatKayitlari', 'hasatTarihi', renderHasatKaydi); }

    async function listeleKayitlar(kId, tip, collName, tarihAdi, renderFn) {
        const listElId = `${tip}-listesi`; const listEl = document.getElementById(listElId); if (!listEl) return; listEl.innerHTML = "<p>Yükleniyor...</p>";
        console.log(`listeleKayitlar: ${collName} -> #${listElId}`);
        try {
            const querySnapshot = await db.collection("kovanlar").doc(kId).collection(collName).orderBy(tarihAdi, "desc").get();
            console.log(`${collName} sorgusu: ${querySnapshot.size} kayıt`);
            if (querySnapshot.empty) { listEl.innerHTML = "<p>Kayıt yok.</p>"; }
            else { listEl.innerHTML = ""; querySnapshot.forEach(doc => { try { renderFn(listEl, doc.id, doc.data()); } catch (e) { console.error(`Render hatası (${tip}, ${doc.id}):`, e); listEl.innerHTML += `<p style='color:red;'>Kayıt yüklenemedi (ID: ${doc.id})</p>`; } }); }
        } catch (error) { console.error(`${collName} listeleme hatası:`, error); listEl.innerHTML = "<p style='color:red;'>Hata oluştu.</p>"; }
        console.log(`listeleKayitlar TAMAMLANDI: ${collName}`);
    }

    // --- Bireysel Kayıt Render Fonksiyonları (DÜZENLEME VE SİLME BUTONLU) ---
    function renderBakimKaydi(listEl, id, kayit) {
        const t = kayit.bakimTarihi ? new Date(kayit.bakimTarihi).toLocaleDateString('tr-TR', { timeZone: 'UTC' }) : '?';
        const k = document.createElement('div'); k.className = 'bakim-listesi-item kayit-listesi-item'; k.id = `kayit-${id}`;
        k.innerHTML = `
            <div class="kayit-icerik"><span>Tarih: ${t}</span><strong>${kayit.yapilanIslem||'?'}</strong> ${kayit.notlar?`<p>Not: ${kayit.notlar}</p>`:''}</div>
            <div class="kayit-duzenleme-formu"> <div class="form-grup"><label>Tarih</label><input type="date" value="${kayit.bakimTarihi||''}"></div><div class="form-grup"><label>İşlem</label><input type="text" value="${kayit.yapilanIslem||''}"></div><div class="form-grup"><label>Notlar</label><textarea rows="2">${kayit.notlar||''}</textarea></div></div>
            <div class="buton-alan"> <button class="buton kayit-duzenle-btn" onclick="toggleKayitEditMode('${id}','bakim',true)">Düzenle</button> <button class="buton kayit-kaydet-btn" onclick="handleKayitGuncelle('bakimKayitlari','${id}','bakim')">Kaydet</button> <button class="buton kayit-iptal-btn" onclick="toggleKayitEditMode('${id}','bakim',false)">İptal</button> <button class="buton kayit-sil-btn" onclick="handleKayitSil('bakimKayitlari','${id}')">Sil</button> </div>`;
        listEl.appendChild(k);
    }
    function renderHastalikKaydi(listEl, id, kayit) {
        const t = kayit.tedaviTarihi ? new Date(kayit.tedaviTarihi).toLocaleDateString('tr-TR', { timeZone: 'UTC' }) : '?';
        const k = document.createElement('div'); k.className = 'hastalik-listesi-item kayit-listesi-item'; k.id = `kayit-${id}`;
        k.innerHTML = `
            <div class="kayit-icerik"><span>Tarih: ${t}</span><strong>${kayit.hastalikAdi||'?'}</strong><p>Yöntem: ${kayit.kullanilanIlac||'?'}</p>${kayit.notlar?`<p>Not: ${kayit.notlar}</p>`:''}</div>
            <div class="kayit-duzenleme-formu"> <div class="form-grup"><label>Tarih</label><input type="date" value="${kayit.tedaviTarihi||''}"></div><div class="form-grup"><label>Hastalık</label><input type="text" list="hastalik-listesi-datalist" value="${kayit.hastalikAdi||''}"></div><div class="form-grup"><label>İlaç/Yöntem</label><input type="text" list="ilac-yontem-listesi-datalist" value="${kayit.kullanilanIlac||''}"></div><div class="form-grup"><label>Notlar</label><textarea rows="2">${kayit.notlar||''}</textarea></div></div>
            <div class="buton-alan"> <button class="buton kayit-duzenle-btn" onclick="toggleKayitEditMode('${id}','hastalik',true)">Düzenle</button> <button class="buton kayit-kaydet-btn" onclick="handleKayitGuncelle('hastalikKayitlari','${id}','hastalik')">Kaydet</button> <button class="buton kayit-iptal-btn" onclick="toggleKayitEditMode('${id}','hastalik',false)">İptal</button> <button class="buton kayit-sil-btn" onclick="handleKayitSil('hastalikKayitlari','${id}')">Sil</button> </div>`;
        listEl.appendChild(k);
    }
    function renderHasatKaydi(listEl, id, kayit) {
        const t = kayit.hasatTarihi ? new Date(kayit.hasatTarihi).toLocaleDateString('tr-TR', { timeZone: 'UTC' }) : '?';
        const k = document.createElement('div'); k.className = 'hasat-listesi-item kayit-listesi-item'; k.id = `kayit-${id}`;
        k.innerHTML = `
            <div class="kayit-icerik"><span>Tarih: ${t}</span><strong>${kayit.hasatMiktari||'?'} kg Hasat</strong> ${kayit.notlar?`<p>Not: ${kayit.notlar}</p>`:''}</div>
            <div class="kayit-duzenleme-formu"> <div class="form-grup"><label>Tarih</label><input type="date" value="${kayit.hasatTarihi||''}"></div><div class="form-grup"><label>Miktar (kg)</label><input type="number" step="0.1" min="0" value="${kayit.hasatMiktari||0}"></div><div class="form-grup"><label>Notlar</label><textarea rows="2">${kayit.notlar||''}</textarea></div></div>
            <div class="buton-alan"> <button class="buton kayit-duzenle-btn" onclick="toggleKayitEditMode('${id}','hasat',true)">Düzenle</button> <button class="buton kayit-kaydet-btn" onclick="handleKayitGuncelle('hasatKayitlari','${id}','hasat')">Kaydet</button> <button class="buton kayit-iptal-btn" onclick="toggleKayitEditMode('${id}','hasat',false)">İptal</button> <button class="buton kayit-sil-btn" onclick="handleKayitSil('hasatKayitlari','${id}')">Sil</button> </div>`;
        listEl.appendChild(k);
    }

    // ======================================================
    // --- KAYIT DÜZENLEME FONKSİYONLARI ---
    // ======================================================
    function toggleKayitEditMode(kayitId, tip, duzenlemeyeGec) {
        console.log(`toggleKayitEditMode: ${kayitId}, ${tip}, ${duzenlemeyeGec}`);
        const kayitElementi = document.getElementById(`kayit-${kayitId}`);
        if (!kayitElementi) { console.error("Kayıt elementi yok:", kayitId); return; }
        if (duzenlemeyeGec) { kayitElementi.classList.add('duzenleniyor'); }
        else { kayitElementi.classList.remove('duzenleniyor'); }
    }

    async function handleKayitGuncelle(collName, kayitId, tip) {
        console.log(`handleKayitGuncelle: ${collName}, ${kayitId}, ${tip}`);
        if (!mevcutKullanici || !kovanId) return; // DOĞRU YAZIM
        const kayitEl = document.getElementById(`kayit-${kayitId}`); if (!kayitEl) return;
        const formEl = kayitEl.querySelector('.kayit-duzenleme-formu'); if (!formEl) return;
        let guncelVeri = {}; const kaydetButonu = kayitEl.querySelector('.kayit-kaydet-btn');
        try {
            if(kaydetButonu) kaydetButonu.disabled = true;
            if (tip === 'bakim') { guncelVeri = { bakimTarihi: formEl.querySelector('input[type="date"]').value, yapilanIslem: formEl.querySelector('input[type="text"]').value, notlar: formEl.querySelector('textarea').value }; }
            else if (tip === 'hastalik') { const i=formEl.querySelectorAll('input'); guncelVeri = { tedaviTarihi: i[0].value, hastalikAdi: i[1].value, kullanilanIlac: i[2].value, notlar: formEl.querySelector('textarea').value }; }
            else if (tip === 'hasat') { guncelVeri = { hasatTarihi: formEl.querySelector('input[type="date"]').value, hasatMiktari: Number(formEl.querySelector('input[type="number"]').value), notlar: formEl.querySelector('textarea').value }; if (isNaN(guncelVeri.hasatMiktari) || guncelVeri.hasatMiktari <= 0) { alert("Miktar > 0"); if(kaydetButonu) kaydetButonu.disabled=false; return; } }
            else { return; }
            guncelVeri.sonGuncelleme = new Date();
            console.log("Güncellenecek Kayıt:", guncelVeri);
            await db.collection("kovanlar").doc(kovanId).collection(collName).doc(kayitId).update(guncelVeri);
            alert("Kayıt güncellendi!");
            toggleKayitEditMode(kayitId, tip, false);
             if (tip === 'bakim') bakimKayitlariniListele(kovanId); // Listeyi yenile
             else if (tip === 'hastalik') hastalikKayitlariniListele(kovanId);
             else if (tip === 'hasat') hasatKayitlariniListele(kovanId);
        } catch (error) { console.error(`${collName} güncelleme hatası:`, error); alert(`Hata: ${error.message}`); }
        finally { if(kaydetButonu) kaydetButonu.disabled = false; }
    }

    // --- KAYIT SİLME (GENEL) ---
    async function handleKayitSil(altCollName, kayitId) {
         console.log(`handleKayitSil: ${altCollName}, ${kayitId}`);
        if (!mevcutKullanici || !kovanId) return; // DOĞRU YAZIM
        if (confirm(`Bu kaydı silmek istediğinizden emin misiniz?`)) {
             const kayitEl = document.getElementById(`kayit-${kayitId}`);
             const silButonu = kayitEl ? kayitEl.querySelector('.kayit-sil-btn') : null;
             try {
                 if(silButonu) silButonu.disabled = true;
                 await db.collection("kovanlar").doc(kovanId).collection(altCollName).doc(kayitId).delete();
                 console.log("Kayıt silindi."); alert("Kayıt silindi.");
                 if(kayitEl) kayitEl.remove(); // DOM'dan kaldır
             } catch (error) { console.error(`${altCollName} silme hatası:`, error); alert(`Hata: ${error.message}`); if(silButonu) silButonu.disabled = false; }
        } else { console.log("Silme iptal edildi."); }
    }

</script>
</body>
</html>