<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Pano Yönetimi</title>
    <link rel="icon" href="5.jpg" type="image/jpeg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 shadow">
    <div class="container">
        <span class="navbar-brand fw-bold"><i class="fa-solid fa-user-shield me-2 text-danger"></i>Yönetim Paneli</span>
        <div class="d-flex align-items-center">
            <a href="pano.html" class="btn btn-outline-light btn-sm me-2"><i class="fa-solid fa-arrow-left"></i> Panoya Dön</a>
            <button id="logoutBtn" class="btn btn-danger btn-sm"><i class="fa-solid fa-right-from-bracket"></i> Çıkış</button>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <div class="card shadow-sm mb-4 border-success">
                <div class="card-header bg-success text-white fw-bold">
                    <i class="fa-solid fa-plus-circle me-2"></i>Yeni Duyuru Yayınla
                </div>
                <div class="card-body">
                    <form id="addForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Başlık</label>
                            <input type="text" id="baslik" class="form-control" placeholder="Duyuru Başlığı" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">İçerik</label>
                            <textarea id="icerik" class="form-control" rows="4" placeholder="Duyuru metnini buraya girin..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-success w-100 fw-bold py-2">
                            <i class="fa-solid fa-paper-plane me-2"></i> Yayınla
                        </button>
                    </form>
                </div>
            </div>

            <h5 class="text-muted mb-3 border-bottom pb-2">Yayındaki Duyurular</h5>
            <div id="adminList">
                <div class="text-center text-muted py-3"><div class="spinner-border spinner-border-sm"></div> Yükleniyor...</div>
            </div>

        </div>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyAO7203PN7V8IBxYe0B13iRy0Ahwzm5sXY", authDomain: "kovan-takip-4c054.firebaseapp.com", projectId: "kovan-takip-4c054", storageBucket: "kovan-takip-4c054.appspot.com", messagingSenderId: "783431210365", appId: "1:783431210365:web:5810ec74c9ff3ba8d4a814" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // GÜVENLİK KONTROLÜ
    auth.onAuthStateChanged(user => {
        if (!user || user.email !== "mremzi@gmail.com") {
            alert("Bu alana sadece yönetici erişebilir!");
            window.location.href = "login.html";
        } else {
            listele();
        }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
        auth.signOut().then(() => window.location.href = "login.html");
    });

    // DUYURU EKLEME
    document.getElementById('addForm').addEventListener('submit', e => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Yayınlanıyor...';

        db.collection("pano").add({
            baslik: document.getElementById('baslik').value,
            icerik: document.getElementById('icerik').value,
            eklenmeTarihi: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            alert("Duyuru başarıyla yayınlandı!");
            e.target.reset();
            listele();
        }).catch(err => {
            alert("Hata: " + err.message);
        }).finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-paper-plane me-2"></i> Yayınla';
        });
    });

    // LİSTELEME
    function listele() {
        db.collection("pano").orderBy("eklenmeTarihi", "desc").get().then(snap => {
            const el = document.getElementById('adminList');
            el.innerHTML = '';
            
            if (snap.empty) {
                el.innerHTML = '<div class="alert alert-secondary text-center">Henüz hiç duyuru yok.</div>';
                return;
            }

            snap.forEach(doc => {
                const d = doc.data();
                // Tarih formatlama (Hata önleyici kontrol ile)
                let tarihStr = "";
                if (d.eklenmeTarihi && d.eklenmeTarihi.toDate) {
                    tarihStr = d.eklenmeTarihi.toDate().toLocaleString('tr-TR');
                }

                const html = `
                    <div class="card mb-3 shadow-sm border-start border-4 border-warning">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="card-title fw-bold text-dark mb-1">${d.baslik}</h5>
                                    <small class="text-muted d-block mb-2"><i class="fa-regular fa-clock"></i> ${tarihStr}</small>
                                    <p class="card-text text-secondary">${d.icerik}</p>
                                </div>
                                <button onclick="sil('${doc.id}')" class="btn btn-outline-danger btn-sm ms-2" title="Sil">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                el.insertAdjacentHTML('beforeend', html);
            });
        });
    }

    // SİLME
    function sil(id) {
        if(confirm("Bu duyuruyu silmek istediğinize emin misiniz?")) {
            db.collection("pano").doc(id).delete()
                .then(() => listele())
                .catch(err => alert("Silme hatası: " + err.message));
        }
    }
</script>
</body>
</html>